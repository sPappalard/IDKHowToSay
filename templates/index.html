<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Learning Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: slideDown 1s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .title {
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(45deg, #fff, #f8f9fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .subtitle {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 300;
        }

        .card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            animation: slideUp 0.8s ease-out;
            transition: all 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }

        .load-section {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #9c27b0, #7b1fa2);
            color: white;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .url-input-section {
            margin: 20px 0;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .form-control {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .form-control:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }

        .status {
            text-align: center;
            padding: 15px;
            border-radius: 15px;
            margin: 20px 0;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .status.success {
            background: rgba(76, 175, 80, 0.2);
            color: #000000; /* Verde ancora pi√π scuro */
            font-weight: bold;
            text-shadow: 0 0 2px white; /* Leggera ombra per migliorare il contrasto */
        }

        .status.error {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .status.loading {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .setting-label {
            color: white;
            font-weight: 500;
        }

        .setting-input {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            width: 80px;
            text-align: center;
        }

        .game-modes {
            display: flex;
            gap: 30px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .mode-btn {
            padding: 25px 40px;
            font-size: 1.2rem;
            border-radius: 20px;
            min-width: 220px;
        }

        .game-screen {
            display: none;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .score-info {
            display: flex;
            gap: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .score-item {
            text-align: center;
            color: white;
        }

        .score-value {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }

        .score-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .question-card {
            text-align: center;
            padding: 40px;
            margin: 30px 0;
        }

        .question-text {
            font-size: 1.8rem;
            color: white;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .question-word {
            font-size: 2.5rem;
            font-weight: bold;
            color: #fff;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .audio-btn {
            background: linear-gradient(45deg, #9c27b0, #7b1fa2);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
        }

        .audio-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(156, 39, 176, 0.4);
        }

        .answer-section {
            margin: 30px 0;
        }

        .answer-label {
            color: white;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: block;
        }

        .answer-input {
            width: 100%;
            max-width: 400px;
            padding: 20px;
            border: none;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.3rem;
            text-align: center;
            margin: 0 auto;
            display: block;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .answer-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 0 30px rgba(255,255,255,0.2);
            background: rgba(255, 255, 255, 0.3);
        }

        .result-message {
            margin: 20px 0;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .result-correct {
            background: linear-gradient(135deg, #4CAF50, #388E3C);
            color: white;
            border: 2px solid #2E7D32;
            text-shadow: 0px 1px 2px rgba(0, 0, 0, 0.3);
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .result-incorrect {
            background: linear-gradient(135deg, #f44336, #D32F2F);
            color: white;
            border: 2px solid #C62828;
            text-shadow: 0px 1px 2px rgba(0, 0, 0, 0.3);
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .result-skipped {
            background: linear-gradient(135deg, #ff9800, #F57C00);
            color: white;
            border: 2px solid #EF6C00;
            text-shadow: 0px 1px 2px rgba(0, 0, 0, 0.3);
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .game-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            border-radius: 10px;
            transition: width 0.5s ease;
            width: 0%;
        }

        @media (max-width: 768px) {
            .title {
                font-size: 2.5rem;
            }
            
            .load-section {
                flex-direction: column;
            }
            
            .game-modes {
                flex-direction: column;
                align-items: center;
            }
            
            .mode-btn {
                min-width: auto;
                width: 100%;
                max-width: 300px;
            }
            
            .game-header {
                flex-direction: column;
                text-align: center;
            }
            
            .question-word {
                font-size: 2rem;
            }
            
            .game-controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Menu Principal -->
        <div id="menu-screen">
            <div class="header">
                <h1 class="title">üéì English Learning Game</h1>
                <p class="subtitle">Impara l'inglese in modo divertente e interattivo</p>
            </div>

            <div class="card">
                <div class="load-section">
                    <button class="btn btn-primary" onclick="loadExcelFile()">
                        <span>üìÅ Carica File Excel</span>
                    </button>
                    <button class="btn btn-secondary" onclick="loadGoogleSheets()">
                        <span>üåê Carica Google Sheets</span>
                    </button>
                </div>

                <div class="url-input-section">
                    <div class="input-group">
                        <input type="text" id="sheets-url" class="form-control" 
                               placeholder="üîó Incolla qui il link del Google Sheets..." 
                               onkeypress="handleUrlKeyPress(event)">
                    </div>
                    <small style="color: rgba(255,255,255,0.7);">
                        üí° Per Google Sheets: condividi il foglio pubblicamente e incolla qui il link
                    </small>
                </div>

                <div id="status" class="status">
                    Nessun dato caricato
                </div>

                <input type="file" id="file-input" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileUpload(event)">
            </div>

            <div class="card">
                <h3 style="color: white; margin-bottom: 20px; text-align: center;">‚öôÔ∏è Impostazioni</h3>
                <div class="settings-grid">
                    <div class="setting-item">
                        <span class="setting-label">Numero massimo domande:</span>
                        <input type="number" id="max-questions" class="setting-input" value="50" min="10" max="500">
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Numero massimo passi:</span>
                        <input type="number" id="max-passes" class="setting-input" value="3" min="0" max="20">
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="game-modes">
                    <button class="btn btn-danger mode-btn" id="eng-ita-btn" onclick="startGame('eng_ita')" disabled>
                        <span>üá¨üáß‚û°Ô∏èüáÆüáπ ENG ‚Üí ITA</span>
                    </button>
                    <button class="btn btn-primary mode-btn" id="ita-eng-btn" onclick="startGame('ita_eng')" disabled>
                        <span>üáÆüáπ‚û°Ô∏èüá¨üáß ITA ‚Üí ENG</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="game-screen">
            <div class="header">
                <h1 class="title" style="font-size: 2rem;">üéØ English Learning Game</h1>
            </div>

            <div class="card">
                <div class="game-header">
                    <div class="score-info">
                        <div class="score-item">
                            <span id="score-value" class="score-value">0</span>
                            <span class="score-label">Punteggio</span>
                        </div>
                        <div class="score-item">
                            <span id="question-progress" class="score-value">0/50</span>
                            <span class="score-label">Domande</span>
                        </div>
                        <div class="score-item">
                            <span id="passes-left" class="score-value">3</span>
                            <span class="score-label">Passi rimasti</span>
                        </div>
                    </div>
                </div>

                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
            </div>

            <div class="card question-card">
                <div id="question-text" class="question-text">Traduci in italiano:</div>
                <div id="question-word" class="question-word">Loading...</div>
                
                <button id="audio-btn" class="audio-btn" onclick="playAudio()" title="Ascolta la pronuncia">
                    üîä
                </button>

                <div class="answer-section">
                    <label class="answer-label">La tua risposta:</label>
                    <input type="text" id="answer-input" class="answer-input" 
                           placeholder="Scrivi qui la traduzione..." 
                           onkeypress="handleAnswerKeyPress(event)">
                </div>

                <div id="result-message" class="result-message"></div>

                <div class="game-controls">
                    <button class="btn btn-primary" onclick="checkAnswer()">
                        <span>‚úì Conferma</span>
                    </button>
                    <button class="btn btn-warning" onclick="passQuestion()">
                        <span>‚è≠Ô∏è Passa</span>
                    </button>
                    <button class="btn btn-danger" onclick="endGame()">
                        <span>üèÅ Termina</span>
                    </button>
                    <button class="btn btn-info" onclick="returnToMenu()">
                        <span>üè† Menu</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variabili globali
        const API_BASE_URL = 'http://localhost:5000/api';

        // Gestione status
        function updateStatus(message, type = 'default') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status';
            
            if (type === 'success') statusEl.classList.add('success');
            else if (type === 'error') statusEl.classList.add('error');
            else if (type === 'loading') statusEl.classList.add('loading');
        }

        // Caricamento file Excel
        function loadExcelFile() {
            document.getElementById('file-input').click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            updateStatus('üîÑ Caricamento in corso...', 'loading');

            const formData = new FormData();
            formData.append('file', file);

            fetch(`${API_BASE_URL}/load_excel`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStatus(data.message, 'success');
                    enableGameButtons();
                } else {
                    updateStatus(data.message, 'error');
                    alert('Errore: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                updateStatus('‚ùå Errore nel caricamento', 'error');
                alert('Errore di connessione con il server');
            });
        }

        // Caricamento Google Sheets
        function loadGoogleSheets() {
            const url = document.getElementById('sheets-url').value.trim();
            if (!url) {
                alert('Inserisci l\'URL del Google Sheets!');
                return;
            }

            updateStatus('üîÑ Caricamento da Google Sheets...', 'loading');
            
            fetch(`${API_BASE_URL}/load_google_sheet`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStatus(data.message, 'success');
                    enableGameButtons();
                } else {
                    updateStatus(data.message, 'error');
                    alert('Errore: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                updateStatus('‚ùå Errore di connessione', 'error');
                alert('Errore di connessione con il server');
            });
        }

        function enableGameButtons() {
            document.getElementById('eng-ita-btn').disabled = false;
            document.getElementById('ita-eng-btn').disabled = false;
        }

        // Gestione eventi
        function handleUrlKeyPress(event) {
            if (event.key === 'Enter') {
                loadGoogleSheets();
            }
        }

        function handleAnswerKeyPress(event) {
            if (event.key === 'Enter') {
                checkAnswer();
            }
        }

        // Gestione gioco
        function startGame(mode) {
            const maxQuestions = parseInt(document.getElementById('max-questions').value);
            const maxPasses = parseInt(document.getElementById('max-passes').value);
            
            fetch(`${API_BASE_URL}/start_game`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    mode: mode, 
                    max_questions: maxQuestions,
                    max_passes: maxPasses
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('menu-screen').style.display = 'none';
                    document.getElementById('game-screen').style.display = 'block';
                    
                    updateGameUI(data);
                } else {
                    alert('Errore: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Errore di connessione con il server');
            });
        }

        function updateGameUI(data) {
            document.getElementById('score-value').textContent = data.score;
            document.getElementById('question-progress').textContent = `${data.questions_asked}/${data.max_questions}`;
            document.getElementById('passes-left').textContent = data.passes_left;
            
            const progressPercent = (data.questions_asked / data.max_questions) * 100;
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;
            
            document.getElementById('question-text').textContent = data.question;
            document.getElementById('question-word').textContent = data.question.split("'")[1];
            
            document.getElementById('answer-input').value = '';
            document.getElementById('answer-input').focus();
            
            // Nascondi il risultato precedente
            const resultEl = document.getElementById('result-message');
            resultEl.textContent = '';
            resultEl.className = 'result-message';
        }

        function nextQuestion() {
            fetch(`${API_BASE_URL}/next_question`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.game_active) {
                        updateGameUI(data);
                    } else {
                        endGame();
                    }
                } else {
                    alert('Errore: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Errore di connessione con il server');
            });
        }

        function checkAnswer() {
            const userAnswer = document.getElementById('answer-input').value.trim();
            if (!userAnswer) return;
            
            fetch(`${API_BASE_URL}/check_answer`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ answer: userAnswer })
            })
            .then(response => response.json())
            .then(data => {
                const resultEl = document.getElementById('result-message');
                
                if (data.correct) {
                    resultEl.textContent = data.message;
                    resultEl.className = 'result-message result-correct';
                } else {
                    resultEl.textContent = data.message;
                    resultEl.className = 'result-message result-incorrect';
                }
                
                document.getElementById('score-value').textContent = data.score;
                
                setTimeout(() => {
                    nextQuestion();
                }, 2000);
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Errore di connessione con il server');
            });
        }

        function passQuestion() {
            fetch(`${API_BASE_URL}/pass_question`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const resultEl = document.getElementById('result-message');
                    resultEl.textContent = data.message;
                    resultEl.className = 'result-message result-skipped';
                    
                    document.getElementById('passes-left').textContent = data.passes_left;
                    
                    setTimeout(() => {
                        nextQuestion();
                    }, 1500);
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Errore di connessione con il server');
            });
        }

        function playAudio() {
            fetch(`${API_BASE_URL}/play_audio`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Errore di connessione con il server');
            });
        }

        function endGame() {
            fetch(`${API_BASE_URL}/end_game`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let message = `üèÅ GIOCO TERMINATO!\n\n`;
                    message += `üìä Risultati:\n`;
                    message += `‚Ä¢ Domande risposte: ${data.questions_asked}\n`;
                    message += `‚Ä¢ Punteggio finale: ${data.final_score}\n`;
                    message += `‚Ä¢ Percentuale: ${data.percentage}%\n\n`;
                    
                    if (data.percentage >= 70) message += 'üéâ Ottimo lavoro!';
                    else if (data.percentage >= 50) message += 'üí™ Continua cos√¨!';
                    else message += 'üìö Serve pi√π pratica!';
                    
                    alert(message);
                    returnToMenu();
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Errore di connessione con il server');
            });
        }

        function returnToMenu() {
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('menu-screen').style.display = 'block';
        }
    </script>
</body>
</html>